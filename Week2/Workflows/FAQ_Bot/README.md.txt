# 📊 iTech FAQ Bot – n8n Workflow (Supabase + Google Sheets)

This repository contains an **n8n workflow** that powers the iTech FAQ Bot.  
It connects **Supabase** (for FAQ search + conversation storage) and **Google Sheets** (for logging + daily summaries).  
The workflow receives user questions via webhook, queries the FAQ database, transforms results, logs conversations, generates daily summaries, and returns responses.

---

## 🚀 Features
- ✅ Receive user questions via **Webhook**
- 🔎 Query **Supabase RPC (search_faqs_simple)** for FAQ answers
- 🤖 Transform results into bot-friendly responses (with confidence scoring)
- 💾 Store full conversations in Supabase
- 📑 Log all Q&A into Google Sheets
- 📈 Generate & update **daily conversation summaries**
- 📤 Respond back to the user in real-time (JSON response)

---

## 📂 Workflow Overview

### Nodes
1. **Receive_UserQuestion_Webhook**  
   - Exposes `POST /faq-bot` endpoint for incoming user questions.  
   - Example request:  
     ```json
     {
       "question": "What services does iTech provide?",
       "user_ip": "203.0.113.42"
     }
     ```

2. **Query_FAQ_Supabase**  
   - Calls Supabase RPC `search_faqs_simple` with the user question.  
   - Returns top 3 keyword-matched FAQs with scores.

3. **Transform_FAQResponse**  
   - Generates a bot-friendly response.  
   - Adds metadata: session_id, confidence, search_method, user_ip, response_time.

4. **Store_Conversation_Supabase**  
   - Saves Q&A session into Supabase `conversations` table.  

5. **Log_Conversation_GoogleSheet**  
   - Appends conversation details into Google Sheet **(All Conversations tab)**.  

6. **Get_DailySummary_Supabase**  
   - Fetches daily summary stats from Supabase view `conversation_summary`.

7. **Transform_DailySummary**  
   - Processes daily stats or generates first-entry summary.  
   - Fields: total questions, avg confidence, success vs failure count, top questions.

8. **Log_DailySummary_GoogleSheet**  
   - Updates Google Sheet **(Daily Summary tab)** with aggregated data.

9. **Send_ResponseToUser**  
   - Sends final JSON response back to webhook caller:  
     ```json
     {
       "success": true,
       "session_id": "abc123xyz",
       "question": "What services does iTech provide?",
       "answer": "We deliver innovative technology and AI-driven solutions...",
       "confidence": 0.92,
       "timestamp": "2025-09-04T12:34:56Z"
     }
     ```

---

## 📊 Google Sheets Integration

Two tabs are maintained:
1. **All Conversations** – Logs each Q&A with timestamp, confidence, response time, etc.
2. **Daily Summary** – Tracks totals, averages, top questions per day.

---

## 🛠️ Setup Instructions

1. **Import Workflow**
   - Copy the JSON (`FAQ_Bot_Supabase_Integration.json`) into n8n via *Import from File*.

2. **Configure Credentials**
   - Supabase: add your project URL + Service Role Key as an API credential.  
   - Google Sheets: connect via OAuth2 in n8n credentials.  

3. **Create Supabase Tables**
   ```sql
   create table conversations (
     id bigint generated by default as identity primary key,
     session_id text,
     user_question text,
     bot_answer text,
     confidence_score float,
     search_method text,
     user_ip text,
     response_time_ms int,
     created_at timestamp default now()
   );

   -- Optional: daily summary view
   create or replace view conversation_summary as
   select
     date(created_at) as date,
     count(*) as total_questions,
     avg(confidence_score) as avg_confidence,
     sum(case when confidence_score > 0 then 1 else 0 end) as successful_answers,
     sum(case when confidence_score = 0 then 1 else 0 end) as failed_answers,
     array_agg(user_question order by created_at desc) as common_questions
   from conversations
   group by date(created_at);

📈 Example Flow

User asks: "How can I contact support?"

Workflow:

Webhook receives → queries Supabase → gets FAQ match.

Response transformed, logged into Supabase + Google Sheets.

Daily summary updated.

User receives:

{
  "success": true,
  "session_id": "xk8yz73f",
  "question": "How can I contact support?",
  "answer": "You can reach our support team at support@itech.example or +20-123-456-789.",
  "confidence": 0.87,
  "timestamp": "2025-09-04T10:15:23Z"
}
